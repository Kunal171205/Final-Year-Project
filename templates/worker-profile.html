<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Profile | Industrial Explorer</title>
  <link rel="stylesheet" href="{{ url_for('static' , filename='css/worker-profile.css' ) }}">
  <script>
    function scrollToKYC() {
      const section = document.getElementById("kyc-section");
    
      fetch("/worker/start-kyc");
      
      section.style.display = "block";
      section.style.opacity = 0;
    
      section.scrollIntoView({ behavior: "smooth" });
    
      let opacity = 0;
      const fadeIn = setInterval(() => {
        opacity += 0.05;
        section.style.opacity = opacity;
        if (opacity >= 1) clearInterval(fadeIn);
      }, 20);
    }
    </script>
    <script>
      function showChangeForm(id) {
        const form = document.getElementById(id);
        if (!form) return;
      
        // Toggle visibility
        form.style.display = (form.style.display === "flex") ? "none" : "flex";
      }
      </script>
      <script>
        function toggleProfileEdit(editMode) {
          document.getElementById("profile-view").style.display =
            editMode ? "none" : "block";
          document.getElementById("profile-edit").style.display =
            editMode ? "block" : "none";
        }
      </script>
      <script>
        function enableEdit() {
          toggleFields(true);
        }
      
        function cancelEdit() {
          toggleFields(false);
        }
      
        function toggleFields(editMode) {
          document.querySelectorAll(".view-field").forEach(el => {
            el.style.display = editMode ? "none" : "inline";
          });
      
          document.querySelectorAll(".edit-field").forEach(el => {
            el.style.display = editMode ? "inline-block" : "none";
          });
      
          document.getElementById("editBtn").style.display =
            editMode ? "none" : "inline-block";
          document.getElementById("saveBtn").style.display =
            editMode ? "inline-block" : "none";
          document.getElementById("cancelBtn").style.display =
            editMode ? "inline-block" : "none";
        }
      
        function saveProfile() {
          fetch("/worker/update-profile", {
            method: "POST",
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              username: document.getElementById("e-username").value,
              email: document.getElementById("e-email").value,
              phone_no: document.getElementById("e-phone").value
            })
          })
          .then(res => res.json())
          .then(data => {
            console.log("Server response:", data);
            if (data.success) {
              document.getElementById("v-username").innerText = data.username;
              document.getElementById("v-email").innerText = data.email;
              document.getElementById("v-phone").innerText = data.phone_no;

              toggleFields(false);
            } else {
              alert(data.message || "Update failed");
           }
          })
          .catch(err => {
            console.error("Fetch error:", err);
            alert("Server error");
          });
        }
      </script>
      
      
      
    
</head>

<body>

<!-- HEADER -->
<header class="top-header">
  <div class="logo">Industrial Explorer</div>
  <nav>
    {% if session.get('user_type') == 'worker' %}
      <a href="{{ url_for('home') }}">Home</a>
      <a href="{{ url_for('jobportal') }}">Job Portal</a>
      <a href="{{ url_for('workerprofile') }}">Profile</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    {% elif session.get('user_type') == 'company' %}
      <a href="{{ url_for('home') }}">Home</a>
      <a href="{{ url_for('b2bhome') }}">B2B Trade</a>
      <a href="{{ url_for('companyprofile') }}">Profile</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    {% else %}
      <a href="{{ url_for('home') }}">Home</a>
      <a href="{{ url_for('jobportal') }}">Job Portal</a>
      <a href="{{ url_for('b2bhome') }}">B2B Trade</a>
      <a href="{{ url_for('logintype') }}">Login</a>
    {% endif %}
  </nav>
</header>

<!-- PAGE -->
<div class="page-container">

  <!-- PROFILE CARD -->
  <div class="profile-card">
    <div class="profile-header">
      <div class="avatar">üë∑</div>
      <div>
        <h2>{{ worker.username }}</h2>
        <p>Worker Profile</p>
      </div>
      
      
  <div class="profile-actions">
    <button id="editBtn"
            class="edit-profile-btn"
            onclick="enableEdit()">
      Edit Profile
    </button>

    <button id="saveBtn"
            class="save-btn"
            onclick="saveProfile()"
            style="display:none;">
      Save
    </button>

    <button id="cancelBtn"
            class="cancel-btn"
            onclick="cancelEdit()"
            style="display:none;">
      Cancel
    </button>
  </div>

    </div>

    <!-- <div class="profile-info">
      <div><strong>Username:</strong> {{ worker.username }}</div>
      <div><strong>Total Applications:</strong> {{ applications|length }}</div>
    </div>
  </div> --><div class="profile-info">

  <!-- USERNAME -->
  <div>
    <strong>Username:</strong>

    <!-- VIEW -->
    <span class="view-field" id="v-username">
      {{ worker.username }}
    </span>

    <!-- EDIT -->
    <input class="edit-field"
           id="e-username"
           type="text"
           name="username"
           value="{{ worker.username }}"
           style="display:none;">
  </div>

  <!-- EMAIL -->
  <div>
    <strong>Email:</strong>

    <span class="view-field" id="v-email">
      {{ worker.email }}
    </span>

    <input class="edit-field"
           id="e-email"
           type="email"
           name="email"
           value="{{ worker.email }}"
           style="display:none;">
  </div>

  <!-- PHONE -->
  <div>
    <strong>Phone:</strong>

    <span class="view-field" id="v-phone">
      {{ worker.phone_no }}
    </span>

    <input class="edit-field"
           id="e-phone"
           type="text"
           name="phone_no"
           value="{{ worker.phone_no }}"
           style="display:none;">
  </div>

  <div>
    <strong>Total Applications:</strong> {{ applications|length }}
  </div>

</div>

  
  </div>

  {% if worker.kyc_status == "pending" %}
<div class="kyc-card">
  <h3>KYC Status</h3>
  <p class="kyc-pending">
    ‚ö†Ô∏è KYC Pending ‚Äì Aadhar & PAN verification required to apply for jobs.
  </p>

  <button class="do-kyc-btn" onclick="scrollToKYC()">
    Do KYC
  </button>
</div>
{% endif %}

  <!-- DOCUMENT UPLOAD CARD -->
  <div class="documents-card"
     id="kyc-section"
     {% if worker.kyc_status == "pending" and not session.get("kyc_started") %}style="display:none;"
{% endif %}>

  <h3>Upload Required Documents</h3>
  <p class="doc-subtitle">
    Aadhar Card and PAN Card are mandatory for job verification.
    Resume is optional.
  </p>

  <h3>Documents</h3>

<!-- AADHAR -->
<div class="doc-row">
  <strong>Aadhar Card:</strong>

  <div class="doc-right">
    {% if worker.aadhar_card %}
      <div class="doc-actions">
        <a href="{{ url_for('static', filename='uploads/' + worker.aadhar_card) }}"
           target="_blank"
           class="view-btn">View</a>

        <button type="button"
                class="change-btn"
                onclick="showChangeForm('aadhar-form')">
          Change
        </button>
      </div>

      <form id="aadhar-form"
            method="POST"
            action="{{ url_for('upload_worker_documents') }}"
            enctype="multipart/form-data"
            class="change-form">
        <input type="file" name="aadhar_card" required>
        <button type="submit" class="upload-btn">Upload</button>
      </form>
    {% else %}
      <form method="POST"
            action="{{ url_for('upload_worker_documents') }}"
            enctype="multipart/form-data">
        <input type="file" name="aadhar_card" required>
        <button type="submit" class="upload-btn">Upload</button>
      </form>
    {% endif %}
  </div>
</div>


<!--PAN-->
<div class="doc-row">
  <strong>PAN Card:</strong>

  <div class="doc-right">
    {% if worker.pan_card %}
      <div class="doc-actions">
        <a href="{{ url_for('static', filename='uploads/' + worker.pan_card) }}"
           target="_blank"
           class="view-btn">View</a>

        <button type="button"
                class="change-btn"
                onclick="showChangeForm('pan-form')">
          Change
        </button>
      </div>

      <form id="pan-form"
            method="POST"
            action="{{ url_for('upload_worker_documents') }}"
            enctype="multipart/form-data"
            class="change-form">
        <input type="file" name="pan_card" required>
        <button type="submit" class="upload-btn">Upload</button>
      </form>
    {% else %}
      <form method="POST"
            action="{{ url_for('upload_worker_documents') }}"
            enctype="multipart/form-data">
        <input type="file" name="pan_card" required>
        <button type="submit" class="upload-btn">Upload</button>
      </form>
    {% endif %}
  </div>
</div>

<!-- RESUME -->
<div class="doc-row">
  <strong>Resume:</strong>

  <div class="doc-right">
    {% if worker.resume %}
      <div class="doc-actions">
        <a href="{{ url_for('static', filename='uploads/' + worker.resume) }}"
           target="_blank"
           class="view-btn">
          View
        </a>

        <button type="button"
                class="change-btn"
                onclick="showChangeForm('resume-form')">
          Change
        </button>
      </div>

      <form id="resume-form"
            method="POST"
            action="{{ url_for('upload_worker_documents') }}"
            enctype="multipart/form-data"
            class="change-form">
        <input type="file" name="resume" accept=".pdf">
        <button type="submit" class="upload-btn">Upload</button>
      </form>

    {% else %}
      <form method="POST"
            action="{{ url_for('upload_worker_documents') }}"
            enctype="multipart/form-data">
        <input type="file" name="resume" accept=".pdf">
        <button type="submit" class="upload-btn">Upload</button>
      </form>
    {% endif %}
  </div>
</div>

</div>


  <!-- APPLIED JOBS -->
<div class="jobs-card">
  <h3>Applied Jobs</h3>

  {% if applications %}
    {% for item in applications %}
    <div class="job-row">

      <div class="job-details">
        <h4>{{ item.job.job_title }}</h4>
        <p>{{ item.job.job_category }} ‚Äì {{ item.job.job_location }}</p>

        <p class="applied-date">
          Applied: {{ item.application_date.strftime('%Y-%m-%d') }}
        </p>
      </div>

      <div class="job-actions">
        <span class="status {{ item.applicant_status }}">
          {{ item.applicant_status|title }}
        </span>

        {% if item.applicant_status == 'pending' %}
        <form method="POST"
              action="{{ url_for('cancel_application', app_id=item.application_id) }}">
          <button type="submit"
                  class="cancel-btn"
                  onclick="return confirm('Cancel this application?')">
            Cancel
          </button>
        </form>
        {% endif %}
      </div>

    </div>
    {% endfor %}
  {% else %}
    <p>You haven't applied for any jobs yet.</p>
    <a href="{{ url_for('jobportal') }}">Browse Jobs</a>
  {% endif %}
</div>

</div>

